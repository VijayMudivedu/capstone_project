---
title: "Hospital Ratings CMS"
author: "Vijay Mudivedu"
date: '2018-09-02'
output:
  html_document:
    fig_caption: yes
    fig_height: 7
    fig_width: 10
    toc: yes
  word_document:
    toc: yes
---

```{r}
#install.packages("mice")
#install.packages("psych")
#install.packages("doParallel")
```


```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE}
library(tidyverse)
#setwd("~/Google Drive/_OneDrive_Atimi_Software/Upgrad/_Upgrad/Capstone_project/")
```


# General Information

```{r capstone}
general_info <- read.csv(file = "ValidFiles/Hospital General Information.csv",header = T,check.names = T,na.strings = c("Not Available",""),
                         stringsAsFactors = T)
str(general_info) 
```


## Filtering the demographic variables not needed for analysis

```{r}
zdemographics <- c("Hospital.Name","Address","City","State","County.Name","Phone.Number","ZIP.Code")
zdemogrphic_vars <- which(names(general_info) %in% zdemographics)

zvar1 <- c("Hospital.Type","Hospital.Ownership","Emergency.Services","Meets.criteria.for.meaningful.use.of.EHRs")
zvar2 <- which(names(general_info) %in% zvar1)
general_info_cleaned <- general_info[,-c(zdemogrphic_vars,zvar2)]
```

# Replacing the empty values in the target variable as "Missing"
```{r}
general_info_cleaned$Hospital.overall.rating[which(is.na(general_info_cleaned$Hospital.overall.rating))] <- "Missing"
general_info_cleaned$Hospital.overall.rating <- as.factor(general_info_cleaned$Hospital.overall.rating)
```

## Check if the NAs in the Ratings are missing at Random in the Footnote

* footnote with levels are inducing the NAs in the dataset: 
    + "Data are shown only for hospitals that participate in the Inpatient Quality Reporting (IQR) and Outpatient Quality Reporting (OQR) programs" is inducing the NAs across the dataset
    + "Data suppressed by CMS for one or more quarters"
* This concludes that the provider ids related this level can be purged from the dataset

* Similarly, "Data suppressed by CMS for one or more quarters" also cannot be used for analysis as this is inducing the NAs across the datasets, which mandates to purge the dataset with missing NAs

```{r}
general_info_cleaned %>% filter(general_info_cleaned$Hospital.overall.rating.footnote %in%
           c("Data are shown only for hospitals that participate in the Inpatient Quality Reporting (IQR) and Outpatient Quality Reporting (OQR) programs",
             "Data suppressed by CMS for one or more quarters","Data suppressed by CMS for one or more quarters","Results are not available for this reporting period")) %>% group_by(Mortality.national.comparison,Readmission.national.comparison,Safety.of.care.national.comparison,Efficient.use.of.medical.imaging.national.comparison,Timeliness.of.care.national.comparison,Effectiveness.of.care.national.comparison,Patient.experience.national.comparison) %>%
  summarise(count_rws = n()) %>% t()
```

* Filtering the footnotes that are leading to NAs Hospital Ratings

```{r}
general_info_cleaned <- general_info_cleaned %>% 
  filter(!general_info_cleaned$Hospital.overall.rating.footnote %in% 
           c("Data are shown only for hospitals that participate in the Inpatient Quality Reporting (IQR) and Outpatient Quality Reporting (OQR) programs",
             "Data suppressed by CMS for one or more quarters","Results are not available for this reporting period"))


```

* Barplot of the ratings show that the Hospital rating has a gaussian distribution
```{r}
ggplot(data = general_info_cleaned,aes(x = Hospital.overall.rating)) + 
  geom_bar(na.rm = T, fill = "steelblue") + geom_text(stat = "count", aes(label = paste0(round(..count../sum(..count..),3)*100)),hjust = 0) + 
  labs(title = "% Distrbution of the Class Variable, Hospital Ratings ") + 
  theme(plot.title = element_text(hjust = 0.5),plot.background = element_blank(),axis.title.y = element_blank(),
        panel.background = element_blank(),axis.text.y = element_text(hjust = 1)) + coord_flip()
```

* checking the level footnote level of Hospital Rating 
  - "There are too few measures or measure groups reported to calculate a star rating or measure group score"
  - "Results are not available for this reporting period"

```{r}
general_info_cleaned %>% 
  filter(general_info_cleaned$Hospital.overall.rating.footnote %in% 
           c("There are too few measures or measure groups reported to calculate a star rating or measure group score")) %>% summary()
```
* The above specific additional footnotes also contribute to the NAs in Hospital Overall Rating with multilevel dependency on the other groups. 
* For example, specified ones below contribue less to NAs, compared to Mortality, Safety of care, Readmission, Efficient Use of medical Imaging.
  + "Patient.experience" , "Effectiveness.of.care", "Timeliness.of.care"

```{r}
general_info_cleaned <- general_info_cleaned %>% 
  filter(!general_info_cleaned$Hospital.overall.rating.footnote %in% 
           c("There are too few measures or measure groups reported to calculate a star rating or measure group score")) 

summary(general_info_cleaned)

```

1. We thus have conclusively arrived at the "general_info_final" dataset with 1-5 hospital ratings imputing the NAs
2. Picking the hospital Rating from the general info cleaned dataset 

```{r}
z_rem_var1 <- which(names(general_info_cleaned) %in% c("Provider.ID","Hospital.overall.rating"))
general_info_final <- general_info_cleaned[is.na(general_info_cleaned$Hospital.overall.rating.footnote),z_rem_var1]
summary(general_info_final)
dim(general_info_final)
```
# Analysing the Complications dataset

```{r}
complications_df <- read.csv(file = "ValidFiles//Complications - Hospital.csv",
                             header = T,check.names = T,stringsAsFactors = T,na.strings = c('Not Available',""))
head(complications_df)
```

* Cleaning the demographic variables that do not have an impact on the Measure IDs

```{r}

zdemographics <- c("Hospital.Name","Address","City","State","ZIP.Code","County.Name","Phone.Number","Measure.Start.Date", "Measure.End.Date")
zdemogrphic_vars <- which(names(complications_df) %in% zdemographics)
complications_df_cleaned <- complications_df[,-zdemogrphic_vars]
head(complications_df_cleaned)
```
- Measuring the distribution of NAs in the Complications dataset, Compared to National, and Footnote variables.
- About 35% of the NAs in Compared to National, and 41% of the records in footnote is stale due to reasons specified in the variable.

```{r}
round(prop.table(summary(factor(complications_df_cleaned$Compared.to.National)))*100,2)  #- Thus NAs are 35% in the Compared.To.National variable
round(prop.table(summary(factor(complications_df_cleaned$Footnote)))*100,2)  #- NAs are 65% in the Footnote variable 
```

### imputation of NAs in Complications dataset
- Analysis of "footnote" variable by checking the impact on the score variable

```{r}
# Distribution of Score and Denominator by Footnote
complications_df_cleaned %>% group_by(Footnote) %>% 
  summarise(cnt_rows = n(),Avg_Score = mean(Score,na.rm = T),Total_Score = sum(Score,na.rm = T)) %>% arrange(Avg_Score)

```

- Footnote Variable: Footnote levels which have specific reasons do not contribute to score variable for the specific Provided.ID,
these rows can be imputed from analysis.

```{r}
zvar1 <- is.na(complications_df$Footnote) # Blank Footnotes
zvar2 <- which(names(complications_df_cleaned) %in% "Footnote")
complications_df_cleaned_footnote_nas <- complications_df_cleaned[zvar1,-zvar2]
summary(complications_df_cleaned_footnote_nas)
```
- Imputing the "NAs" resulted in inducing the variability in each of the variables. 

# which variable is contributing most NAs  in "Score" variable?

```{r}
library(reshape2)

complications_df_cleaned_footnote_nas %>% group_by(Measure.ID) %>% 
  summarise(cnt_rws = n(), mean_Score = round(mean(Score,na.rm = T))) %>% 
  arrange(desc(cnt_rws)) %>% melt(value.name = c("value")) %>%
  ggplot(aes(x = Measure.ID,y = value)) + geom_col(fill = "steelblue") + geom_text(aes(label = value),hjust = 1,vjust = 0.5,angle = 90) +
  facet_wrap(facets = ~ variable,scales = "free",ncol = 3) +  labs(title = "Complications measure") +
  theme(axis.text.x = element_text(angle = 60,vjust = 1,hjust = 1), plot.title = element_text(hjust = 0.5))
```

- Significant Measures from this dataset measures are "PSI_90_SAFETY","PSI_4_SURG_COMP" "COMP_HIP_KNEE"

- rejecting the Denominoator, Lower Estimate, Higher Estimate, Compared.to.National variables
- Important measures are 

```{r}
zvar1 <- c( "Provider.ID", "Measure.ID", "Score")
zvar2 <- which(names(complications_df_cleaned_footnote_nas) %in% zvar1)

complications_df_final <-  complications_df_cleaned_footnote_nas[,zvar2] %>%  spread(key = Measure.ID,value = Score)
summary(complications_df_final)
# PSI_8_POST_HIP data is stale with no contribution to the overall score and  minimal.
complications_df_final <- complications_df_final[,-which(names(complications_df_final) %in% "PSI_8_POST_HIP")]
```

- Some of the variables exhibit that high variability compared to other measures are for example, "PSI_90_SAFETY","COMP_HIP_KNEE", "PSI_4_SURG_COMP" 
- Considering the signficant variable measures from these Complications Dataset

```{r}
zvar1 <- which(names(complications_df_final) %in% c("Provider.ID","PSI_90_SAFETY","COMP_HIP_KNEE","PSI_4_SURG_COMP"))
complications_df_final <- complications_df_final[,zvar1]
library(psych)
pairs.panels(x = complications_df_final[2:ncol(complications_df_final)], main = "Complications dataset correlation ",
             bg = rainbow(n = 12),smooth = TRUE, ellipses = TRUE,pch = 21,cex.cor = 0.85,cex.labels = 0.6)

```

# Analysis for Healthcare Associated Infections - For Hosptial

```{r}
hai_df <- read.csv(file = "~/Google Drive/_OneDrive_Atimi_Software/Upgrad/_Upgrad/Capstone_project/capstone_project/ValidFiles/Healthcare Associated Infections - Hospital.csv",na.strings = c("Not Available",""))
```

```{r}
summary(hai_df)
```

- Removing the demographic variables, Address, City, State, ZIP.Code, County.Name,Phone.Number,Footnote

```{r}
zdemographics <- c("Hospital.Name","Address","City","State","County.Name","Phone.Number","ZIP.Code","Measure.Start.Date","Measure.End.Date")
hai_df_cleaned <- hai_df[,-which(names(hai_df) %in% c(zdemographics))]
```

- Imputing the NAs from the Hospital Associated Infections dataset - Variables, Footnote with values

```{r}
hai_df_cleaned %>% group_by(Footnote) %>% summarise(count_rows = n(),score_total = sum(Score,na.rm = T))
```
- Footnote variable that briefs out the imperfections associated with the score for each related level
- Considering the blank in the footnotes that carry more weightage to the score

```{r}
zvar1 <- which(names(hai_df_cleaned) %in% c("Footnote"))
hai_df_cleaned <- hai_df_cleaned[is.na(hai_df_cleaned$Footnote),-zvar1]  
summary(hai_df_cleaned) # running the summary on the after removing the invalid footnotes
```

# determine the outliers in the Score

```{r}
hai_df_cleaned %>% group_by(Measure.ID) %>% summarise(count_rows = n(), per_mean_score = mean(Score)*100) %>%
ggplot(aes(x = Measure.ID,y = count_rows)) +
  geom_col(fill = "steelblue") + geom_text(aes(label = count_rows),vjust = -0.5,angle = 0) +
  xlab("Measure.ID") + labs(title = "Healthcare Associated Infections") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1,vjust = 1),plot.title = element_text(hjust = 0.5))

```

* There are abnormal outliers in the dataset from the measure IDs HAI_1_DOPC_Days, besides this they do not contribute to the overall score
- Summarising the distribution of the measures. 

- A central line-associated bloodstream infection (CLABSI) is a serious infection that occurs when germs (usually bacteria or viruses) enter the bloodstream through the central line. Healthcare providers must follow a strict protocol when inserting the line to make sure the line remains sterile and a CLABSI does not occur. In addition to inserting the central line properly, healthcare providers must use stringent infection control practices each time they check the line or change the dressing. Patients who get a CLABSI have a fever, and might also have red skin and soreness around the central line. If this happens, healthcare providers can do tests to learn if there is an infection present.

-Clostridium difficile (C. difficile) is a bacteria that causes diarrhea and can lead to serious complications. Those at highest risk for C. difficile infection include people who take antibiotics and also receive care in any medical setting, including hospitals. C. difficile bacteria produce spores that can be spread from patient to patient. Symptoms from C. diff infections often take a few days to develop. Patients are tested for C. diff. infections if they show signs of illness while in the hospital. This measure compares the number of stool specimens that tested positive for C. diff toxin four or more days after the patient entered the hospital to a national benchmark.

- CAUTI -Catheter Associated Urinary Tract Infections: A urinary tract infection (UTI) is an infection involving any part of the urinary system, including urethra, bladder, ureters, and kidney. UTIs are the most common type of healthcare-associated infection reported to the National Healthcare Safety Network (NHSN).  Among UTIs acquired in the hospital, approximately 75% are associated with a urinary catheter, which is a tube inserted into the bladder through the urethra to drain urine.  Between 15-25% of hospitalized patients receive urinary catheters during their hospital stay.  The most important risk factor for developing a catheter-associated UTI (CAUTI) is prolonged use of the urinary catheter.  Therefore, catheters should only be used for appropriate indications and should be removed as soon as they are no longer needed.

- Considering the SIRs, that Centre for Diesease Control and Prevention uses to calculate, Standard Infection Ratio (SIR) which takes into account patient care location, number of patients with an exisiting infection, lab mehtords, bed size, afficialiton with a medical schools, bed size of the hospital, age of patients.

- central line-associated bloodstream infections (CLABSI), catheter- associated urinary tract infections (CAUTI), surgical site infection (SSI) from colon surgery or abdominal hysterectomy, methicillin-resistant Staphylococcus Aureus (MRSA) blood laboratory-identified events (bloodstream infections), and Clostridium difficile (C.diff.) laboratory-identified events (intestinal infections). The HAI measures show how often patients in a particular hospital contract certain infections during the couse of their medical treatment

HAI_1_SIR, HAI_1a_SIR, HAI_2_SIR, HAI_2a_SIR, HAI_6_SIR,HAI_4_SIR, HAI_5_SIR, HAI_3_SIR

HAI-1 measure tracks central-line associated bloodstream infections (CLABSI) in ICUs and select wards. 
HAI-2 measure tracks catheter-associated urinary tract infections (CAUTI) in ICUs and select wards. 
HAI-3 Surgical Site Infection from colon surgery (SSI: Colon)
HAI-4 Surgical Site Infection from abdominal hysterectomy (SSI: Hysterectomy)
HAI-5 Methicillin-resistant Staphylococcus Aureus (MRSA) Blood Laboratory-identified Events (Bloodstream infections)
HAI-6 Clostridium difficile (C.diff.) Laboratory-identified Events (Intestinal infections)


```{r}
hai_measures <- c("HAI_1_SIR", "HAI_2_SIR", "HAI_3_SIR", "HAI_4_SIR", "HAI_5_SIR", "HAI_6_SIR")

# Filterig the measure.ids useful for analysis
hai_df_cleaned <- hai_df_cleaned[which(hai_df_cleaned$Measure.ID %in% hai_measures),]

```

```{r}
ggplot(data = hai_df_cleaned,aes(x = Measure.ID)) + 
  geom_bar(fill = "steelblue",na.rm = TRUE) + xlab("Measure.ID") + geom_text(stat = "count",aes(label = ..count..),vjust = -.1) +
  labs(title = "Hospital Associated Infections by Measure by Hospital Count") +
  theme(axis.text.x = element_text(angle = 45,vjust = 1,hjust = 1))

```


- selecting the required measures for analysis

```{r}
zvar1 <- c( "Provider.ID", "Measure.ID", "Score")
zvar2 <- which(names(hai_df_cleaned) %in% zvar1)

hai_df_final <- hai_df_cleaned[,zvar2] %>% spread(key = "Measure.ID",value = "Score")
#hai_df_final$COMP_HIP_KNEE <- complications_df_final$COMP_HIP_KNEE - these items cannot be combined they have differing levels of records
summary(hai_df_final)
```

```{r}
pairs.panels(x = hai_df_final[,-1],cex.cor = 0.5,cex.labels = 0.9,ellipses = TRUE,pch = 21,bg = rainbow(length(zvar1)), 
             main = "Hospital Patient Safety Group variable correlation" )

```

- The hospital associated infections group groups variable sare

- merging the data complications final with general information dataset 
```{r}
gen_inf_compli_df <- merge(x = general_info_final,y = complications_df_final,all = TRUE, by = intersect(x = names(general_info_final),y = names(complications_df_final)))

safety_of_care_group <- merge(x = gen_inf_compli_df,y = hai_df_final,all = TRUE,by = intersect(x = names(gen_inf_compli_df),y = names(hai_df_final)))
head(safety_of_care_group)
```

# Analysis of HCAPHS dataset

```{r}
hcaphs_df <- read.csv(file = "ValidFiles/HCAHPS - Hospital.csv",header = TRUE,check.names = TRUE,na.strings = c("Not Available","Not Applicable",""))
```

# removing the demographic columns, Mesaure Start Date and measure end data columns

```{r}
zdemographics
hcaphs_df_cleaned <- hcaphs_df[,-which(names(hcaphs_df) %in% zdemographics)]
```

- Extracting the Measure IDs that are of importance from:
H_COMP_1_LINEAR_SCORE, H_COMP_2_LINEAR_SCORE, H_COMP_3_LINEAR_SCORE, H_COMP_4_LINEAR_SCORE, H_COMP_5_LINEAR_SCORE, 
H_COMP_6_LINEAR_SCORE, H_COMP_7_LINEAR_SCORE, H_HSP_RATING_LINEAR_SCORE, H_QUIET_LINEAR_SCORE,H_RECMND_LINEAR_SCORE, H_CLEAN_LINEAR_SCORE, 

* selecting the required measures
```{r}
hcaphs_measures <- c("H_COMP_1_LINEAR_SCORE", "H_COMP_2_LINEAR_SCORE", "H_COMP_3_LINEAR_SCORE", "H_COMP_4_LINEAR_SCORE", "H_COMP_5_LINEAR_SCORE", 
"H_COMP_6_LINEAR_SCORE", "H_COMP_7_LINEAR_SCORE", "H_HSP_RATING_LINEAR_SCORE", "H_QUIET_LINEAR_SCORE","H_RECMND_LINEAR_SCORE", "H_CLEAN_LINEAR_SCORE")

hcaphs_df_measures <- hcaphs_df_cleaned %>% filter(hcaphs_df_cleaned$HCAHPS.Measure.ID %in% hcaphs_measures)
hcaphs_df_measures$HCAHPS.Measure.ID <- as.character(hcaphs_df_measures$HCAHPS.Measure.ID)
hcaphs_df_measures$HCAHPS.Measure.ID <- str_replace(string = hcaphs_df_measures$HCAHPS.Measure.ID,pattern = "_LINEAR_SCORE",replacement = "")
hcaphs_df_measures$HCAHPS.Measure.ID <- as.factor(hcaphs_df_measures$HCAHPS.Measure.ID)
```


```{r}
zdistri_vars <- c("Provider.ID","HCAHPS.Measure.ID","HCAHPS.Linear.Mean.Value","Number.of.Completed.Surveys",
                  "Survey.Response.Rate.Percent.Footnote","Number.of.Completed.Surveys.Footnote")

hcaphs_df_measures_distri <- hcaphs_df_measures[,zdistri_vars] 
hcaphs_df_measures_distri[is.na(hcaphs_df_measures_distri$HCAHPS.Linear.Mean.Value),] %>% summary()

```

- which meansures have NA scores?

- Eliminating the rows that have NA scores  1. too few cases to report, 2. Results are unavailable for the current reporting period 3. Data Specific to IQR and OQR

```{r}
hcaphs_df_measures_distri[is.na(hcaphs_df_measures_distri$Survey.Response.Rate.Percent.Footnote),] %>% summary()
hcaphs_df_measures_distri <- hcaphs_df_measures_distri[is.na(hcaphs_df_measures_distri$Survey.Response.Rate.Percent.Footnote),c(1,2,3)]
```

* creating the patient experience group spreading the measure ids

```{r}
patient_exp_group <- hcaphs_df_measures_distri %>% spread(key = HCAHPS.Measure.ID, value = HCAHPS.Linear.Mean.Value)
summary(patient_exp_group)
```
```{r}
pairs.panels(patient_exp_group[,-1],cex.labels = 0.6 ,cex.cor = 0.7,main = "Patient Experience Relationship between measures")
```

- Patient experience measures are uniformly distributed about their mean. Each of the measures have a strong correlation between them.
   +  Cleanliness of Hospital Environment (Q8)  - H_Clean_HSP
   +  Nurse Communication (Q1, Q2, Q3)          - H_COMP_1
   +  Doctor Communication (Q5, Q6, Q7)         _ H_COMP_2
   +  Responsiveness of Hospital Staff (Q4, Q11)- H_COMP_3 
   +  Pain management (Q13, Q14)                - H_COMP_4
   +  Communication About Medicines (Q16, Q17)  - H_COMP_5
   +  Discharge Information (Q19, Q20)          - H_COMP_6
   +  Overall Rating of Hospital (Q21)          - H_OVERALL_RATING
   +  Quietness of Hospital Environment (Q9)    - H_QUIET_HSP
   +  Willingness to Recommend Hospital (Q22)   - H_RECMND
   +  HCAHPS 3 Item Care Transition Measure (CTM-3) - - H_COMP_7 

- Merging the patient experience group dataframe with the master dataframe

```{r}
master_df  <- merge(x = safety_of_care_group,y = patient_exp_group,by = intersect(names(safety_of_care_group),names(patient_exp_group)),all = TRUE)
head(master_df)
```

# Analysis of Timeliness and Effectiveness of Care Dataset

```{r}
time_and_eff_care_df <- read.csv(file = "ValidFiles/Timely and Effective Care - Hospital.csv",header = T,check.names = T,stringsAsFactors = T,na.strings = c("Not Available",""))
str(time_and_eff_care_df)
```
# cleaning the demographic variables from the dataset

```{r}
zdemogrphic_vars <- which(names(time_and_eff_care_df) %in% zdemographics)
time_and_eff_care_cleaned <- time_and_eff_care_df[,-zdemogrphic_vars]
```

* NA Imputation in the Score Variable
* considering the Footnote levels as a reference to impute the NAs, the levels below satisfy the non-stale data category.
 + 1. Blank Levels (NA) 2.  "2 - Data submitted were based on a sample of cases/patients."

```{r}
time_and_eff_care_cleaned %>% group_by(Footnote) %>% summary(cnt_rows=n())
```

- The footnote level "2 - Data submitted were based on a sample of cases/patients." has valid data the and this affects the overall score of the patients
- So keeping the Footnote level and removing the dataset that have NAs

```{r}
time_and_eff_care_cleaned$Score <- as.integer(time_and_eff_care_cleaned$Score)
time_and_eff_care_imputed <- time_and_eff_care_cleaned[is.na(time_and_eff_care_cleaned$Footnote) | (time_and_eff_care_cleaned$Footnote %in% c("2 - Data submitted were based on a sample of cases/patients.")),] 
time_and_eff_care_imputed %>% summary()
```

* Subsetting the data by removing the NA from Samples 

```{r}
time_and_eff_care_imputed <- time_and_eff_care_imputed[!is.na(time_and_eff_care_imputed$Sample),]
summary(time_and_eff_care_imputed)
```

- Performing the validation checks after imputing the NAs in the dataset
```{r}
# Samples Vs Score
time_and_eff_care_imputed %>% group_by(Measure.ID) %>% summarise(mean_score = round(mean(Score))) %>%
ggplot(aes(Measure.ID,mean_score)) + geom_col(fill = "steelblue") + 
  geom_text(aes(label = mean_score),vjust = 0.5,angle = 90,hjust = 1) +
  labs(title = "Measure.ID Vs Scores") +
  theme(axis.text.x = element_text(angle = 60,vjust = 1,hjust = 1),
        plot.title = element_text(hjust = 0.5))
```
AMI_71, AMI7b though have high mean scores, there aren't many providers

```{r}
ggplot(time_and_eff_care_imputed, aes(Measure.ID)) + geom_bar(fill = "steelblue") + 
  geom_text(stat = "count",aes(label = ..count..),vjust = 0.5,angle = 90,hjust = 0) +
  labs(title = "Timeliness and Effectiveness Measure.ID Vs Count of Providers") +
  theme(axis.text.x = element_text(angle = 45,vjust = 1,hjust = 1),
        plot.title = element_text(hjust = 0.5))
```

* Measures that contribute lessser to the overall score and that are have lesser providers ids are eliminated from the analysis
Grouping the Effectiveness Measures and Timeliness Measures:
- *Timeliness Group*: ED_1b,ED_2b,OP_18b, OP_3, OP_5, OP_20,OP_21
ED-1b 	Median Time from ED Arrival to ED Departure for Admitted ED Patients 
ED-2b 	Admit Decision Time to ED Departure Time for Admitted Patients 
OP-3  	Median Time to Transfer to Another Facility for Acute Coronary Intervention 
OP-5 	  Median Time to ECG 
OP-18b 	Median Time from ED Arrival to ED Departure for Discharged ED Patients 
OP-20 	Door to Diagnostic Evaluation by a Qualified Medical Professional 
OP-21 	ED-Median Time to Pain Management for Long Bone Fracture 

- *Effectiveness Group*: CAC_3,IMM_2,IMM_3_OP_27_FAC_ADHPCT,OP_22,OP_23,OP_29,OP_30,OP_4,PC_01,STK_1, STK_4, STK_6,STK_8,VTE_1,VTE_2,VTE_3,VTE_5, VTE_6
CAC-3 	Home Management Plan of Care (HMPC) Document Given to Patient/Caregiver 
IMM-2 	Influenza Immunization 
IMM-3/OP-27 	Healthcare Personnel Influenza Vaccination 
OP-4 	  Aspirin at Arrival 
OP-22 	ED-Patient Left Without Being Seen 
OP-23 	ED-Head CT or MRI Scan Results for Acute Ischemic Stroke or Hemorrhagic Stroke who Received Head CT or MRI Scan Interpretation Within 45 Minutes of Arrival 
OP-29 	Endoscopy/Polyp Surveillance: Appropriate Follow-Up Interval for Normal Colonoscopy in Average Risk Patients 
OP-30 	Endoscopy/Polyp Surveillance: Colonoscopy Interval for Patients with a History of Adenomatous Polyps – Avoidance of Inappropriate Use 
PC-01 	Elective Delivery Prior to 39 Completed Weeks Gestation: Percentage of Babies Electively Delivered Prior to 39 Completed Weeks Gestation 
STK-1 	Venous Thromboembolism (VTE) Prophylaxis 
STK-4 	Thrombolytic Therapy 
STK-6 	Discharged on Statin Medication 
STK-8 	Stroke Education 
VTE-3 	Venous Thromboembolism Patients with Anticoagulation Overlap Therapy 
VTE-1 	Venous Thromboembolism Prophylaxis 
VTE-2 	Intensive Care Unit Venous Thromboembolism Prophylaxis 
VTE-5 	Venous Thromboembolism Warfarin Therapy Discharge Instructions 
VTE-6 	Hospital Acquired Potentially-Preventable Venous Thromboembolism 

* Separating the the measure variables needed for analysis

```{r}
zvar1 <-  which(names(time_and_eff_care_imputed) %in% c("Provider.ID","Measure.ID","Score"))
timeliness_group <- time_and_eff_care_imputed[,zvar1] %>% spread(key = Measure.ID,value = Score)
zvar1 <- which(names(timeliness_group) %in% c("Provider.ID","ED_1b","ED_2b","OP_18b", "OP_3b", "OP_5", "OP_20","OP_21"))
zvar2 <- which(names(timeliness_group) %in% c("Provider.ID","CAC_3","IMM_2","IMM_3_OP_27_FAC_ADHPCT","OP_22","OP_23","OP_29","OP_30","OP_4","PC_01","STK_1", "STK_4", "STK_6","STK_8","VTE_1","VTE_2","VTE_3","VTE_5", "VTE_6"))

effectiveness_group <- timeliness_group[,zvar2]
timeliness_group <- timeliness_group[,zvar1]
```

* check the correlation between the measure variables

```{r}
pairs.panels(x = timeliness_group[2:length(zvar1)],cex.cor = 0.5,cex.labels = 0.9,ellipses = TRUE,pch = 21,bg = rainbow(length(zvar1)), main = "Timeliness Group variable correlation" )
```
- most of the measure variables of timeliness group are uncorrelated.
- ED_1B and ED_2B are the inversely correlated to some extent as the timespent in the emergency room is the common between them. They are inversely correlated as the doctors visit reduces the time spend by the patient before moving to ED to inpatient room is reduced.

```{r}
zvar1 <- which(names(effectiveness_group) %in% "IMM_3_OP_27_FAC_ADHPCT")
names(effectiveness_group)[zvar1] <- "IMM_3_OP_27"

```

```{r}
cor.plot(effectiveness_group[,-1],
        stars = FALSE,numbers = TRUE,colors = TRUE,cex = 0.5, show.legend = FALSE,
         xlas = 2,cex.axis = 0.6,main = "Effectiveness group measure correlation")
```
- Variables represented by the effectiveness group have small degree of correlation

- Merging the timliness group and effectiveness group with master dataframe

```{r}
# merging master dataframe with timliness group
master_df <- merge(x = master_df,y = timeliness_group,by = intersect(names(master_df),names(timeliness_group)),all = TRUE)

# merging master dataframe with effectiveness group
master_df <- merge(x = master_df,y = effectiveness_group,by = intersect(names(master_df),names(effectiveness_group)),all = TRUE)
summary(master_df)
```

# Analysing the Readmission and Mortality groups

```{r}
readm_mort_df <- read.csv(file = "ValidFiles/Readmissions and Deaths - Hospital.csv",check.names = T,header = T,stringsAsFactors = T,na.strings = c("Not Available",""))
```

* Purging the demographic variables not needed in the analysis 

```{r}
zdemogrphic_vars <- which(names(readm_mort_df) %in% c(zdemographics,"Measure.Name","Compared.to.National"))
readm_mort_cleaned <- readm_mort_df[,-zdemogrphic_vars]
```

* Analysing the footnote variable

```{r}
summary(readm_mort_cleaned)
```
### Imputing the NAs

* Considering the Footnote variable as the reference variable. Assuming that the levels specified below encapsulate the NAs in the dataset. A summary rollover on the dataset breifs the situation that below levels holds NAs

 1 - The number of cases/patients is too few to report.
19 - Data are shown only for hospitals that participate in the Inpatient Quality Reporting (IQR) and Outpatient Quality Reporting (OQR) programs.
 4 - Data suppressed by CMS for one or more quarters.  
 5 - Results are not available for this reporting period.
 7 - No cases met the criteria for this measure.


```{r}
readm_mort_cleaned[!is.na(readm_mort_cleaned$Footnote),] %>% group_by(Footnote) %>% summarise(cnt_rows = n(),avg_score = mean(Score,na.rm = T))
```

* imputing the rows that are as a reslut of stale data from different levels of footnotes
```{r}
readm_mort_cleaned <- readm_mort_cleaned[is.na(readm_mort_cleaned$Footnote),]
```


```{r}
readm_mort_cleaned %>% group_by(Measure.ID) %>% summarise(Score = sum(Score)) %>%
ggplot(aes(Measure.ID,Score)) + geom_col(fill = "steelblue") + geom_text(aes(label = Score),vjust = -0.2,size = 3) +
  labs(title = "Mortality Readmission Rate Score") + ylab(label = "Provider Count") + 
  theme(axis.text.x = element_text(angle = 45,vjust = 1,hjust = 1),
        plot.title = element_text(hjust = 0.5)) 
```

* Plotting the Measure variables

```{r}
ggplot(readm_mort_cleaned,aes(Measure.ID)) + geom_bar(fill = "steelblue") + geom_text(stat = "count",aes(label = ..count..),vjust = -.1) +
  labs(title = "Mortality Readmission Rate Count by Providers") + ylab(label = "Provider Count") +
  theme(axis.text.x = element_text(angle = 45,vjust = 1,hjust = 1),axis.text.y = element_blank(),
        plot.title = element_text(hjust = 0.5)) 
```

* *Readmission* measure that contribute to the overall count are:

READM-30-AMI 	Acute Myocardial Infarction (AMI) 30-Day Readmission Rate 
READM-30-COPD Chronic Obstructive Pulmonary Disease (COPD) 30-Day Readmission Rate 
READM-30-CABG Coronary Artery Bypass Graft (CABG) 30-Day Readmission Rate 
READM-30-HF 	Heart Failure (HF) 30-Day Readmission Rate 
READM-30-Hip-Knee 	Hospital-Level 30-Day All-Cause Risk- Standardized Readmission Rate (RSRR) Following Elective Total Hip Arthroplasty (THA)/ Total Knee Arthroplasty (TKA) 
READM-30-PN 	Pneumonia (PN) 30-Day Readmission Rate 
READM-30-STK 	Stroke (STK) 30-Day Readmission Rate 
READM-30-HOSP-WIDE 	HWR Hospital-Wide All-Cause Unplanned Readmission

* *Mortality* group that contribute to Overall Hospital Rating are:
MORT-30-AMI 	Acute Myocardial Infarction (AMI) 30-Day Mortality Rate 
MORT-30-CABG 	Coronary Artery Bypass Graft (CABG) 30-Day Mortality Rate 
MORT-30-COPD 	Chronic Obstructive Pulmonary Disease (COPD) 30-Day Mortality Rate 
MORT-30-HF 	Heart Failure (HF) 30-Day Mortality Rate 
MORT-30-PN 	Pneumonia (PN) 30-Day Mortality Rate 
MORT-30-STK 	Acute Ischemic Stroke (STK) 30-Day Mortality Rate 

```{r}
levels(readm_mort_cleaned$Measure.ID)
zvar1 <- which(names(readm_mort_cleaned) %in% c("Provider.ID","Measure.ID","Score"))
readm_mort_final <- readm_mort_cleaned[,zvar1] %>% spread(key = Measure.ID,value = Score)
```

# Separating the mortality measure and readmission measure

```{r}
zvar1 <- which(names(readm_mort_final) %in% c("Provider.ID","MORT_30_AMI","MORT_30_CABG","MORT_30_COPD","MORT_30_HF","MORT_30_PN","MORT_30_STK"))
mortality_grp <- readm_mort_final[,zvar1]
#mortality_grp$PSI_4_SURG_COMP <- safety_of_care_group$PSI_4_SURG_COMP #These groups cannot be combined as they has different records
zvar1 <- which(names(readm_mort_final) %in% c("MORT_30_AMI","MORT_30_CABG","MORT_30_COPD","MORT_30_HF","MORT_30_PN","MORT_30_STK"))
readmission_grp <- readm_mort_final[,-zvar1]
```

```{r}
dim(readmission_grp)
dim(mortality_grp)
```

# Checking the correlation between different measures
```{r}
pairs.panels(mortality_grp[,-1],scale = TRUE,ellipses = TRUE,pch = 21,bg = rainbow(n = ncol(readmission_grp)),cex.labels = 0.6,cex.cor = 2,main = "Mortality Group Correlation Plot")
```

```{r}
pairs.panels(readmission_grp[,-1],scale = TRUE,ellipses = TRUE,pch = 21,bg = rainbow(n = ncol(readmission_grp)),cex.labels = 0.6,cex.cor = 2,main = "Readmission Group Correlation Plot")
```

* All varaibles in the dataset are significant and thus are being retained into the final dataframe
* Two variables that are significant and strong correlation between them are: 
+ 1. Readmission_Hospital_Wide and Readm_PN death rate
+ 2. Readmission-after discharge and Heart Failure
+ 3. Readmission after discharge and COPD

Ailments are significantly correlated.

* Combining the mortality and readmission group with the master dataframe.

```{r}
master_df <- merge(x = master_df,y = readm_mort_final,by = intersect(x = names(master_df),y = names(readm_mort_final)),all = TRUE)
```

# Analysis of Imaging dataset

```{r}
op_imaging_eff_df <- read.csv(file = "ValidFiles/Outpatient Imaging Efficiency - Hospital.csv",header = T,check.names = T,na.strings = c("Not Available",""),stringsAsFactors = T)
head(op_imaging_eff_df)
```

# Purging the variables that are not useful for analysis

```{r}
zdemogrphic_vars <- which(names(op_imaging_eff_df) %in% c(zdemographics,"Measure.Start.Date","Measure.End.Date"))
op_imaging_eff_cleaned <- op_imaging_eff_df[,-zdemogrphic_vars]
head(op_imaging_eff_cleaned)
```

```{r}
summary(op_imaging_eff_cleaned)
```

* NA imputation in the Score variables
* which measures Scores have NAs? 
In order to check the NAs, Footnote is taken as reference to validate the NAs

```{r}
op_imaging_eff_cleaned[is.na(op_imaging_eff_cleaned$Footnote),] %>% summary()
```

*  From the summary we can infer that most of the NAs in the score are induced by Stale data represented by all classess of Footnotes
* Imptuting the footnote levels

```{r}
op_imaging_eff_cleaned <- op_imaging_eff_cleaned[is.na(op_imaging_eff_cleaned$Footnote),] 
```
# Plotting the trends of Measure Variables acorss the providers
```{r}
ggplot(op_imaging_eff_cleaned,aes(Measure.ID)) + geom_bar(fill = "steelblue") + 
  geom_text(stat = "count",aes(label = ..count..),vjust = -0.2,angle = 0,hjust = 0.5) +
  labs(title = "Count of Providers by Imaging Efficiency measures") + 
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
op_imaging_eff_cleaned %>% group_by(Measure.ID) %>% summarise(mean_score = mean(Score)) %>%
ggplot(aes(Measure.ID, mean_score)) + geom_col(fill = "steelblue") + 
  geom_text(aes(label = round(mean_score,1)),vjust = -0.1,angle = 0,hjust = 0.5) +
  labs(title = "Mean Score of Measures for Imaging Efficiency") + 
  theme(plot.title = element_text(hjust = 0.5))
```

* Considering the imaging parameters OP_8,OP_10,OP_11,OP_13,OP_14

*Oupatient Imaging Efficiency Group:*
OP-8 	  MRI Lumbar Spine for Low Back Pain 
OP-10 	Abdomen CT Use of Contrast Material 
OP-11 	Thorax CT Use of Contrast Material 
OP-13 	Cardiac Imaging for Preoperative Risk Assessment for Non-Cardiac Low-Risk Surgery 
OP-14 	Simultaneous Use of Brain Computed Tomography (CT) and Sinus CT 

```{r}
zvar1 <- c("Provider.ID","Measure.ID","Score")
zvar2 <- which(names(op_imaging_eff_cleaned) %in% zvar1)
op_imaging_eff_final <- op_imaging_eff_cleaned[,zvar2] %>% spread(key = Measure.ID,value = Score)

# dropping the less singificant OP_9 measure
op_imaging_eff_final <- op_imaging_eff_final[,-ncol(op_imaging_eff_final)]
head(op_imaging_eff_final)
```
* Checking the variability
```{r}
pairs.panels(op_imaging_eff_final[,-1],scale = T,smooth = T,density = T,ellipses = T,pch = 21,method = 'pearson',cex.labels = 1,cex.cor = 2,
             main = "Correlation between Imagining Efficiency Measures ")
```
* Data variablility is uniform acorss the dataset except the Op_10 and OP-11 measure which are closely correlated with skewed distribution

* Merging the imaging the dataframe with Master_dataframe

```{r}
master_df_final <- merge(x = master_df,y = op_imaging_eff_final,by = intersect(x = names(master_df),y = names(op_imaging_eff_final)),all = TRUE) 
head(master_df_final)
```

* removing the provider.id and re arranging the hospital overall rating column

Next steps:
1. check outliers in the measures
2. imputing missing values

# which rows have all NAs?

```{r}
na_indices <- apply(master_df_final[,-c(1,2)], MARGIN = 1, function(x) all(is.na(x)))
sum(na_indices) # there are no columsn with all NAs
```

# Replace NA's in the final master_df with Missing
```{r}
master_df_final$Hospital.overall.rating[which(is.na(master_df_final$Hospital.overall.rating))] <- "Missing"
```


```{r}
library(mice)
master_df_imputed <- mice(data = master_df_final[,-c(1,2)],seed = 100,maxit = 5,m = 5)
master_df_imputed_final <-  mice::complete(data = master_df_imputed,action = 5)
master_df_imputed_final <- cbind(Provider.ID = master_df_final$Provider.ID,master_df_imputed_final)
```

# Using Random Forest

# Spliting the dataset into training and testing 

```{r}
set.seed(100)

master_df_model <- data.frame(Hospital.overall.rating = master_df_final$Hospital.overall.rating,master_df_imputed_final)

# Sampling
indices <- sample(1:nrow(master_df_model),0.7 * nrow(master_df_model))

# training dataset
train_df <- master_df_model[indices,]
# test dataset
test_df <- master_df_model[-indices,]
```

# Model building
### using RandomForest Algorithm

```{r}
set.seed(100)
library(randomForest)
library(caret)
library(doParallel)
doParallel::registerDoParallel(cl = 4,cores = 4)

train_control_rf <- trainControl(method = "repeatedcv",
                                  repeats = 5,
                                  number = 5,
                                  search = "grid",
                                  sampling = "smote",
                                 allowParallel = TRUE)

# Tuning grid parameters of Random Forest
tuning_grid_rf <- expand.grid(.mtry = round(sqrt(ncol(train_df[,-1]))),ntree = seq(100,1000,100)) 

# training the random forest with training dataset
model_rf <- randomForest(Hospital.overall.rating ~.,
                         data = train_df,
                         trControl = train_control_rf,
                         tuneGrid = tuning_grid_rf,
                         metric = "auc",
                         na.action = na.roughfix,
                         scale = TRUE,
                         seed = 100)
model_rf
```

### Predicting the Hospital Ratings

```{r}
vars_predict <- setdiff(x = names(train_df[,-1]),y = "Hospital.overall.rating")
predict_rf <- stats::predict(object = model_rf,test_df[vars_predict])
# Confusion Matrix
confusionMatrix(predict_rf,test_df$Hospital.overall.rating)
```

### using RandomForest Algorithm for Hospitals ignoring the  Missing Rating

## Ignoring the Hospitals with missing Hospital Ratings and buding a random Forest model for the remaining dataset

```{r}
set.seed(100)

master_df_model <- data.frame(Hospital.overall.rating = master_df_final$Hospital.overall.rating,master_df_imputed_final)

# Removing the Hospital with Hospital Rating as "Missing"
ratings <- master_df_model$Hospital.overall.rating
ratings[ratings %in% "Missing"] <- NA
ratings <- as.integer(ratings)
master_df_model_no_Missing <- data.frame(Hospital.overall.rating = ratings,master_df_model[,-1])

master_df_model_no_Missing <- master_df_model_no_Missing[!is.na(master_df_model_no_Missing$Hospital.overall.rating),]
master_df_model_no_Missing$Hospital.overall.rating <- as.factor(master_df_model_no_Missing$Hospital.overall.rating)

# Sampling
indices_no_missing <- sample(1:nrow(master_df_model_no_Missing),0.7 * nrow(master_df_model_no_Missing))

# training dataset
train_df <- master_df_model_no_Missing[indices_no_missing,]
# test dataset
test_df <- master_df_model_no_Missing[-indices_no_missing,]
```

### using RandomForest Algorithm for Hospitals ignoring the  Missing Rating

```{r}
set.seed(100)
library(randomForest)
library(caret)
library(doParallel)
doParallel::registerDoParallel(cl = 4,cores = 4)

train_control_rf <- trainControl(method = "repeatedcv",
                                  repeats = 5,
                                  number = 5,
                                  search = "grid",
                                  sampling = "smote",
                                 allowParallel = TRUE)

# Tuning grid parameters of Random Forest
tuning_grid_rf <- expand.grid(.mtry = round(sqrt(ncol(train_df[,-1]))),ntree = seq(100,1000,100)) 

# training the random forest with training dataset
model_rf_no_na <- randomForest(Hospital.overall.rating ~.,
                         data = train_df,
                         trControl = train_control_rf,
                         tuneGrid = tuning_grid_rf,
                         metric = "auc",
                         na.action = na.roughfix,
                         scale = TRUE,
                         seed = 100)
model_rf_no_na
```

```{r}
vars_predict <- setdiff(x = names(train_df[,-1]),y = "Hospital.overall.rating")
predict_rf <- stats::predict(object = model_rf_no_na,test_df[vars_predict])
# Confusion Matrix
confusionMatrix(predict_rf,test_df$Hospital.overall.rating)
```

# Predicting the rating of missing Ratings using the randomForest
```{r}
# Dataframe of Missing ratings
master_df_model_Missing <- data.frame(Hospital.overall.rating = ratings,master_df_model[,-c(1)])
master_df_model_Missing <- master_df_model_Missing[is.na(master_df_model_Missing$Hospital.overall.rating),]

predicted_rating_missing_Values <- predict(model_rf_no_na,master_df_model_Missing[,-1])

#assigning the predicted values to missing
master_df_model_Missing$Hospital.overall.rating <- predicted_rating_missing_Values

# combining the missing and no missing rows
predict_master_df <- rbind(master_df_model_no_Missing,master_df_model_Missing) 

```


```{r}
str(master_df_model)
str(final_scores)
```

## predicting the missing using the random forest model

```{r}

```




Groups identified so far are:
Outcome Groups:
1. Mortality group  -
2. Saftey of Care +
3. Readmission  -
4. Patient Experience  +
Process Groups:
5. Effectiveness of Care +
6. Timeliness of care - 
7. Efficient Use of Imaging +


## 1 Safety of Care Group
## Latent variable model
```{r}
# safety of care
zvar2 <- c("Provider.ID","COMP_HIP_KNEE","PSI_90_SAFETY","HAI_1_SIR","HAI_2_SIR","HAI_3_SIR","HAI_4_SIR","HAI_5_SIR","HAI_6_SIR")
zvar1 <- which(names(master_df_imputed_final) %in% zvar2)

# scaled # winsorized 
safety_of_care_group <- master_df_imputed_final[,zvar1][,-1] %>% scale() %>% winsor(trim = 0.0125)

plot(density(safety_of_care_group))
```


# Latent Variable Model - Factor Analysis technique to identify the underlying factors in the continuous variable

Latent Variable model is used to summarize the information. For the Star Rating LVM assumes that each measure reflects information about the underlying unobserved dimension of quality. 

LVM is constructed for each group independently.

- Different approaches to factor analysis to identify the factors
- Using the psych library functions to:
  - 1. identify a the factors
  - 2. compute the factors

```{r}

nfactors(x=safety_of_care_group,n=20,
         rotate="varimax",diagonal=FALSE,
         fm="ml",title="Number of Factors",pch=16,use="complete")
fa.parallel(x = safety_of_care_group,fm = "ml",fa = "both",plot = TRUE,n.iter = 1,use = "complete")

```

```{r}

# factoring method, fm = "pa" pa- principal axis, rotate = with max variance, minres - min resume
fm = "ml" # maximum likelihood
rotate = "varimax" # varimax rotation to obtain maximum variance between the measons

safety_care_fact_anal <- fa(r = safety_of_care_group,nfactors = 5,rotate = rotate,fm = fm)
safety_care_fact_anal
# Computing the average rowmeans of all factors scores
safety_of_care_group_scores <- data.frame(Provider.ID = master_df_imputed_final$Provider.ID ,
                                          safe_of_care_score = rowMeans(as.data.frame(safety_care_fact_anal$scores)))
```


## 2 patient_experience Group
## Latent Variable model
```{r}
# safety of care
zvar2 <- c("Provider.ID","H_CLEAN","H_COMP_1","H_COMP_2","H_COMP_3","H_COMP_4","H_COMP_5","H_COMP_6","H_COMP_7","H_HSP_RATING","H_QUIET","H_RECMND")
zvar1 <- which(names(master_df_imputed_final) %in% zvar2)

# scaling the patient experience group and winsoring between +/- 3Sigma
patient_experience_group <- master_df_imputed_final[,zvar1][,-1] %>% scale() %>% winsor(trim = 0.0125)
head(patient_experience_group)
plot(density(patient_experience_group))
```


## Patient experience latent model

```{r}
# Applying the latent view factor analysis
nfactors(patient_experience_group,rotate = "varimax",fm = "ml",pch = 16,use = "complete") 
fa.parallel(x = patient_experience_group,fm = "ml",fa = "both",plot = TRUE,n.iter = 1)

```

```{r}

# there are five factors that explain the variance between the groups

patient_exp_factor_anal <- fa(patient_experience_group,nfactors = 4,rotate = "varimax",scores = "regression",fm = "ml")
patient_exp_factor_anal
patient_experience_group_scores <- data.frame(Provider.ID = master_df_imputed_final$Provider.ID,
                                              patient_exp = rowMeans(as.data.frame(patient_exp_factor_anal$scores)))
```


## 3 readmission group
## Latent Variable model
```{r}
# safety of care
zvar2 <- c("Provider.ID","READM_30_AMI","READM_30_CABG","READM_30_COPD","READM_30_HF","READM_30_HIP_KNEE","READM_30_HOSP_WIDE","READM_30_PN","READM_30_STK")
zvar1 <- which(names(master_df_imputed_final) %in% zvar2)

# scaling the patient experience group and winsoring between +/- 3Sigma
readmission_group <- master_df_imputed_final[,zvar1][,-1] %>% scale() %>% winsor(trim = 0.0125) *direction
plot(density(readmission_group))
```

```{r}
# Applying the latent view factor analysis to identify the factors in the readmission group
nfactors(readmission_group) 
fa.parallel(x = readmission_group,fm = "ml",fa = "both",plot = TRUE,n.iter = 1,sim = FALSE)


```

```{r}
# First five factors that explain the maximum variance between the groups
readmission_group_factor_anal <- fa(readmission_group,nfactors = 3,rotate = "varimax",scores = "regression",fm = "ml")
readmission_group_factor_anal

readmission_group_score <- data.frame(Provider.ID = master_df_imputed_final$Provider.ID,
                                              readmission_score = rowMeans(as.data.frame(readmission_group_factor_anal$scores)))
```

## 4 mortality group

```{r}
# safety of care
zvar2 <- c("Provider.ID","MORT_30_AMI","MORT_30_CABG","MORT_30_COPD","MORT_30_HF","MORT_30_PN","MORT_30_STK","PSI_4_SURG_COMP")
zvar1 <- which(names(master_df_imputed_final) %in% zvar2)

# scaling the patient experience group and winsoring between +/- 3Sigma
mortality_group <- master_df_imputed_final[,zvar1][,-1] %>% scale() %>% winsor(trim = 0.0125) * direction
plot(density(mortality_group))
```

### Applying the Latent Variable Model # Factor analysis
```{r}
# Applying the latent view factor analysis
nfactors(mortality_group) 
fa.parallel(x = mortality_group,fm = "ml",fa = "both",plot = TRUE,n.iter = 1,sim = FALSE)


```

```{r}
# First three factors that explain the maximum variance between the groups
# Parllel analysis suggest = 3 factors that explains the common variance
mortality_group_factor_anal <- fa(mortality_group,nfactors = 3,rotate = "varimax",scores = "regression",fm = "ml")
mortality_group_factor_anal

mortality_group_scores <- data.frame(Provider.ID = master_df_imputed_final$Provider.ID,
                                              mortality_score = rowMeans(as.data.frame(mortality_group_factor_anal$scores)))
```


## 5. Process Group 4% - Effectiveness Group

```{r}
# safety of care
zvar2 <- c("Provider.ID","CAC_3","IMM_2","IMM_3_OP_27","OP_22","OP_23","OP_29","OP_30","OP_4","PC_01","STK_1","STK_4","STK_6","STK_8","VTE_1","VTE_2","VTE_3","VTE_5","VTE_6")
zvar1 <- which(names(master_df_imputed_final) %in% zvar2)

# scaling the patient experience group and winsoring between +/- 3Sigma
effectiveness_group <- master_df_imputed_final[,zvar1][,-1] %>% scale() %>% winsor(trim = 0.0125)
plot(density(effectiveness_group))

```


### LVM - effectiveness group

```{r}
# Applying the latent view factor analysis
nfactors(effectiveness_group) 
fa.parallel(x = effectiveness_group,fm = "minres",fa = "both",plot = TRUE,n.iter = 1,sim = FALSE)

```

- parallel factor analysis, eight factors that explain the maximum variance between the groups, 
-- applying the factor analysis

```{r}
effectiveness_group_factor_anal <- fa(effectiveness_group,nfactors = 8,rotate = "varimax",scores = "regression",fm = "ml")
effectiveness_group_factor_anal
effectiveness_group_scores <- data.frame(Provider.ID = master_df_imputed_final$Provider.ID,
                                              effectiveness_score = rowMeans(as.data.frame(effectiveness_group_factor_anal$scores)))
```

## 6 timeliness Group
```{r}
zvar2 <- c("Provider.ID","ED_1b","ED_2b","OP_18b","OP_20","OP_21","OP_3b","OP_5")
zvar1 <- which(names(master_df_imputed_final) %in% zvar2)

# scaling the timeliness between +/1 3Sigma and winsorizing the scores
timeliness_group <- master_df_imputed_final[,zvar1][,-1] %>% scale() %>% winsor(trim = 0.0125) * direction
plot(density(timeliness_group))
```

### LVM - timelines group

```{r}
# Applying the latent view factor analysis
nfactors(timeliness_group) 
fa.parallel(x = timeliness_group,fm = "ml",fa = "both",plot = TRUE,n.iter = 1,sim = FALSE)
```
--  First five factors that explain the maximum variance between the group measures

```{r}

timeliness_group_factor_anal <- fa(timeliness_group,nfactors = 5,rotate = "varimax",scores = "regression",fm = "ml")
timeliness_group_factor_anal

timeliness_group_scores <- data.frame(Provider.ID = master_df_imputed_final$Provider.ID,
                                              timeliness_score = rowMeans(as.data.frame(timeliness_group_factor_anal$scores)))
```

## 7 medical imagine efficiency group

```{r}
# safety of care
zvar2 <- c("Provider.ID","OP_10","OP_11","OP_13","OP_14","OP_8")
zvar1 <- which(names(master_df_imputed_final) %in% zvar2)

# scaling the patient experience group and winsoring between +/- 3Sigma
medical_imaging_efficiency_group <- master_df_imputed_final[,zvar1][,-1] %>% scale() %>% winsor(trim = 0.0125)
plot(density(medical_imaging_efficiency_group))
```


```{r}
# Applying the latent view factor analysis
nfactors(medical_imaging_efficiency_group) 
fa.parallel(x = medical_imaging_efficiency_group,fm = "ml",fa = "both",plot = TRUE,n.iter = 1,sim = FALSE)

# First five factors that explain the maximum variance between the groups
imaging_eff_group_factor_anal <- fa(medical_imaging_efficiency_group[,-1],nfactors = 3,rotate = "varimax",scores = "regression",fm = "ml")
imaging_eff_group_factor_anal

medical_imaging_group_scores <- data.frame(Provider.ID = master_df_imputed_final$Provider.ID,
                                              imaging_eff = rowMeans(as.data.frame(imaging_eff_group_factor_anal$scores)))

```


## binding the all the groups scores and preparing the final scores table.
Adding the weightages specified by the CMS
The outcome groups have 22% weightage
Process groups have 4% weightage

```{r}
out_grp_weight = 0.22
process_group_weight = 0.04
final_scores <- cbind(Provider.ID=patient_experience_group_scores[,1], 
                      patient_exp =patient_experience_group_scores[,-1]*out_grp_weight,
                      safe_of_care=safety_of_care_group_scores[,-1]* out_grp_weight,
                      readmission=readmission_group_score[,-1]*out_grp_weight,
                      mortality=mortality_group_scores[,-1]*out_grp_weight,
                      timeliness = timeliness_group_scores[,-1]*process_group_weight,
                      effectiveness_score = effectiveness_group_scores[,-1]*process_group_weight,
                      imaging_eff = medical_imaging_group_scores[,-1]*process_group_weight)
```


```{r}


# K-means clustering algorithm to the dataset
# applying the Clustering Algorithm


# logic to identify the knee
n_clusters <- 50

r_squared <- rnorm(n_clusters)

gc()
for(i in 1:n_clusters) {
  
  kmeans_clustering <- kmeans(x = final_scores[,-1],centers = i,nstart = 50,iter.max = 50,algorithm="Hartigan-Wong")
  r_squared[i] <- (kmeans_clustering$betweenss)/(kmeans_clustering$totss)
  }

plot(r_squared)


# with 5 clustering
kmeans_clustering <- kmeans(x = final_scores[,-1],centers = 5,iter.max = 50L,nstart = 50)

# Assigning clusters to the final_scores
final_scores <- as.data.frame(final_scores)
final_scores$rating_clster <- as.factor(kmeans_clustering$cluster)

table(final_scores$rating_clster)
```


```{r}

library(caret)
str(final_scores)
str(master_df_final$Hospital.overall.rating)
confusionMatrix(factor(predict_rf),reference = factor(final_scores$rating_clster))

table(predict_rf,final_scores$rating_clster)
length(factor(predict_rf))

```






